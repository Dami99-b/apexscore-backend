<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ApexScore AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel (to allow JSX in browser) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const API_BASE = "https://apexscore.onrender.com";

    function App() {
      const [stats, setStats] = React.useState(null);
      const [applicants, setApplicants] = React.useState([]);
      const [selected, setSelected] = React.useState(null);

      React.useEffect(() => {
        fetch(API_BASE + "/api/stats")
          .then(res => res.json())
          .then(setStats);

        fetch(API_BASE + "/api/applicants")
          .then(res => res.json())
          .then(d => setApplicants(d.applicants || []));
      }, []);

      const openApplicant = (id) => {
        fetch(API_BASE + "/api/applicant/" + id)
          .then(res => res.json())
          .then(setSelected);
      };

      return (
        <div className="max-w-6xl mx-auto p-6 space-y-6">
          <h1 className="text-3xl font-black text-red-700">ApexScore AI</h1>

          {/* Stats */}
          {stats && (
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <Stat label="Applicants" value={stats.total_applicants} />
              <Stat label="Active Defaults" value={stats.active_defaults} />
              <Stat label="High Risk %" value={stats.high_risk_percentage} />
              <Stat label="Model Confidence" value="98%" />
            </div>
          )}

          {/* Applicants Table */}
          <div className="bg-white rounded-xl shadow border">
            <table className="w-full">
              <thead className="bg-gray-100 text-xs uppercase">
                <tr>
                  <th className="p-3 text-left">Name</th>
                  <th className="p-3 text-left">Occupation</th>
                  <th className="p-3">Score</th>
                  <th className="p-3">Risk</th>
                </tr>
              </thead>
              <tbody>
                {applicants.map(a => (
                  <tr key={a.id}
                      className="border-t hover:bg-gray-50 cursor-pointer"
                      onClick={() => openApplicant(a.id)}>
                    <td className="p-3 font-semibold">{a.name}</td>
                    <td className="p-3">{a.occupation}</td>
                    <td className="p-3 text-center">{a.apex_score}</td>
                    <td className="p-3 text-center">{a.risk_level}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Applicant Details */}
          {selected && (
            <div className="bg-white p-6 rounded-xl shadow border space-y-6">
              <h2 className="text-2xl font-bold">{selected.name}</h2>

              <Section title="Identity & Contact">
                <Row label="Phone" value={selected.phone} />
                <Row label="Email" value={selected.email} />
                <Row label="Occupation" value={selected.occupation} />
                <Row label="Address" value={selected.location?.address} />
                <Row label="City" value={`${selected.location?.city}, ${selected.location?.country}`} />
              </Section>

              <Section title="ApexScore">
                <Row label="Score" value={selected.apex_score} />
                <Row label="Risk Level" value={selected.risk_level} />
                <Row label="Has Default" value={String(selected.has_default)} />
              </Section>

              <Section title="Traditional Financial Data">
                <Row label="Outstanding Debt"
                     value={`${selected.tfd.currency} ${selected.tfd.outstanding_debt}`} />

                <h4 className="font-semibold mt-2">Loan History</h4>
                <ul className="list-disc ml-6">
                  {selected.tfd.loan_history.map((l, i) => (
                    <li key={i}>{l.institution} – {l.amount} ({l.date})</li>
                  ))}
                </ul>

                <h4 className="font-semibold mt-2">Repayment History</h4>
                <ul className="list-disc ml-6">
                  {selected.tfd.repayment_history.map((r, i) => (
                    <li key={i}>
                      {r.date} – {r.status} – {r.amount}
                      {r.days_late ? ` (${r.days_late} days late)` : ""}
                    </li>
                  ))}
                </ul>
              </Section>

              <Section title="Behavioral Stability Index (BSI)">
                {Object.entries(selected.bsi).map(([k, v]) => (
                  <Row key={k} label={k.replaceAll("_", " ")} value={v} />
                ))}
              </Section>

              <Section title="System Recommendation">
                <Row label="Action" value={selected.action_recommendation.action_type} />
                <Row label="Priority" value={selected.action_recommendation.priority} />
                <p className="mt-2 text-sm">
                  {selected.action_recommendation.recommendation}
                </p>
              </Section>
            </div>
          )}
        </div>
      );
    }

    const Stat = ({ label, value }) => (
      <div className="bg-white p-4 rounded shadow border">
        <p className="text-xs text-gray-500">{label}</p>
        <p className="text-2xl font-bold">{value}</p>
      </div>
    );

    const Section = ({ title, children }) => (
      <div>
        <h3 className="text-lg font-bold mb-2">{title}</h3>
        {children}
      </div>
    );

    const Row = ({ label, value }) => (
      <div className="flex justify-between border-b py-1 text-sm">
        <span className="font-medium">{label}</span>
        <span>{value}</span>
      </div>
    );

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
