<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ApexScore â€“ AI-Powered Loan Risk Intelligence</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @keyframes slideLeft {
    from { transform: translateX(0); }
    to { transform: translateX(-50%); }
  }
  .marquee-content {
    animation: slideLeft 30s linear infinite;
  }
</style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-gray-900 to-black text-white min-h-screen">

<header class="border-b border-white/10 bg-black/40 backdrop-blur-sm sticky top-0 z-40">
  <div class="px-6 py-4">
    <div class="flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
          <span class="text-xl font-black">A</span>
        </div>
        <div>
          <h1 class="text-2xl font-black">ApexScore</h1>
          <p class="text-xs text-gray-400">AI Risk Intelligence</p>
        </div>
      </div>
      
      <div class="flex gap-2">
        <input id="searchInput" placeholder="Search email..." class="px-3 py-2 text-sm rounded-lg text-black w-64">
        <button id="searchBtn" class="bg-blue-600 text-white px-4 py-2 text-sm rounded-lg hover:bg-blue-700">Search</button>
        <button id="testBtn" class="bg-green-600 text-white px-4 py-2 text-sm rounded-lg hover:bg-green-700">TEST API</button>
      </div>
    </div>
  </div>
</header>

<div class="bg-gradient-to-r from-blue-600/20 via-purple-600/20 to-pink-600/20 border-y border-white/10 overflow-hidden py-2">
  <div class="flex whitespace-nowrap marquee-content">
    <span class="inline-flex items-center gap-8 text-sm">
      <span>ðŸš€ Real-time AI Risk Assessment</span>
      <span>|</span>
      <span>ðŸ“Š 94% Accuracy Rate</span>
      <span>|</span>
      <span>ðŸ”’ Fully Auditable</span>
      <span>|</span>
      <span>ðŸš€ Real-time AI Risk Assessment</span>
      <span>|</span>
      <span>ðŸ“Š 94% Accuracy Rate</span>
      <span>|</span>
      <span>ðŸ”’ Fully Auditable</span>
    </span>
  </div>
</div>

<div class="px-6 py-6">
  <div class="grid grid-cols-4 gap-4 mb-6">
    <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-5">
      <div class="text-xs text-gray-400 mb-1">Total Applicants</div>
      <div class="text-3xl font-bold" id="totalApplicants">0</div>
    </div>
    <div class="bg-red-500/10 border border-red-500/20 rounded-xl p-5">
      <div class="text-xs text-gray-400 mb-1">High Risk</div>
      <div class="text-3xl font-bold text-red-400" id="highRiskCount">0</div>
    </div>
    <div class="bg-green-500/10 border border-green-500/20 rounded-xl p-5">
      <div class="text-xs text-gray-400 mb-1">Avg Score</div>
      <div class="text-3xl font-bold text-green-400" id="avgScore">0</div>
    </div>
    <div class="bg-purple-500/10 border border-purple-500/20 rounded-xl p-5">
      <div class="text-xs text-gray-400 mb-1">Speed</div>
      <div class="text-3xl font-bold text-purple-400">&lt;500ms</div>
    </div>
  </div>

  <div class="bg-black/40 border border-white/10 rounded-xl overflow-hidden">
    <div class="px-6 py-4 border-b border-white/10 flex justify-between">
      <h2 class="text-lg font-bold">Risk Dashboard</h2>
      <div class="text-xs text-gray-400"><span id="tableCount">0</span> loaded</div>
    </div>
    
    <table class="w-full text-sm">
      <thead>
        <tr class="text-gray-400 border-b border-white/10 bg-white/5">
          <th class="text-left px-6 py-4">Email</th>
          <th class="text-left px-6 py-4">Name</th>
          <th class="text-left px-6 py-4">City</th>
          <th class="text-left px-6 py-4">Score</th>
          <th class="text-left px-6 py-4">Risk</th>
        </tr>
      </thead>
      <tbody id="table">
        <tr><td colspan="5" class="px-6 py-8 text-center">Click TEST API button</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-gray-900 border border-white/20 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center px-8 py-6 border-b border-white/10 sticky top-0 bg-gray-900">
      <h2 class="text-2xl font-bold" id="modalTitle">Details</h2>
      <button id="closeModal" class="text-3xl">&times;</button>
    </div>
    <div class="p-8" id="modalContent"></div>
  </div>
</div>

<script>
const API = "https://apexscore.onrender.com";
let data = [];

console.log("ðŸŸ¢ Script loaded!");

function showStatus(msg, color = "yellow") {
  document.getElementById('table').innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-${color}-400">${msg}</td></tr>`;
}

async function testAPI() {
  console.log("ðŸ”µ Testing API...");
  showStatus("Loading from API...", "blue");
  
  try {
    const url = API + "/api/applicants?limit=40";
    console.log("ðŸ“¡ Fetching:", url);
    
    const res = await fetch(url);
    console.log("ðŸ“¥ Status:", res.status);
    
    if (!res.ok) throw new Error("HTTP " + res.status);
    
    const json = await res.json();
    console.log("âœ… Response:", json);
    
    if (json.applicants && json.applicants.length > 0) {
      data = json.applicants;
      console.log("âœ… Loaded", data.length, "applicants");
      render();
      updateStats();
      showStatus("âœ… Loaded " + data.length + " applicants!", "green");
      setTimeout(() => render(), 1000);
    } else {
      showStatus("âš ï¸ API returned 0 applicants", "yellow");
    }
  } catch(e) {
    console.error("âŒ", e);
    showStatus("âŒ Error: " + e.message, "red");
  }
}

function updateStats() {
  const total = data.length;
  const high = data.filter(a => a.risk_level === "High").length;
  const avg = total > 0 ? Math.round(data.reduce((s, a) => s + a.apex_score, 0) / total) : 0;
  
  document.getElementById('totalApplicants').textContent = total;
  document.getElementById('highRiskCount').textContent = high;
  document.getElementById('avgScore').textContent = avg;
  document.getElementById('tableCount').textContent = total;
}

function render() {
  const tbody = document.getElementById("table");
  tbody.innerHTML = "";
  
  data.forEach(a => {
    const tr = document.createElement("tr");
    tr.className = "border-b border-white/5 hover:bg-white/5 cursor-pointer";
    tr.onclick = () => showDetail(a);
    
    const riskColors = {
      "Low": "bg-green-500/20 text-green-400",
      "Medium": "bg-yellow-500/20 text-yellow-400",
      "High": "bg-red-500/20 text-red-400"
    };
    
    const scoreColor = a.apex_score >= 75 ? "text-green-400" : a.apex_score >= 50 ? "text-yellow-400" : "text-red-400";
    
    tr.innerHTML = `
      <td class="px-6 py-4">${a.email}</td>
      <td class="px-6 py-4">${a.name.full}</td>
      <td class="px-6 py-4">${a.location.city}</td>
      <td class="px-6 py-4 font-bold ${scoreColor}">${a.apex_score}</td>
      <td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-xs ${riskColors[a.risk_level]}">${a.risk_level}</span></td>
    `;
    tbody.appendChild(tr);
  });
}

async function searchEmail() {
  const email = document.getElementById('searchInput').value.trim();
  if (!email) {
    alert("Enter an email");
    return;
  }
  
  try {
    const res = await fetch(API + "/api/search?email=" + encodeURIComponent(email));
    const applicant = await res.json();
    
    if (applicant && applicant.email) {
      showDetail(applicant);
    } else {
      alert("Not found");
    }
  } catch(e) {
    alert("Search failed: " + e.message);
  }
}

function showDetail(a) {
  document.getElementById('modalTitle').textContent = a.name.full;
  document.getElementById('modalContent').innerHTML = `
    <div class="text-center mb-6">
      <div class="text-6xl font-black mb-2">${a.apex_score}</div>
      <div class="text-sm text-gray-400">ApexScore Risk Rating</div>
    </div>
    
    <div class="space-y-4">
      <div class="bg-white/5 rounded-lg p-4">
        <strong>Email:</strong> ${a.email}<br>
        <strong>Phone:</strong> ${a.phone}<br>
        <strong>Occupation:</strong> ${a.occupation}<br>
        <strong>City:</strong> ${a.location.city}, ${a.location.country}
      </div>
      
      <div class="bg-white/5 rounded-lg p-4">
        <strong>Device:</strong> ${a.device_fingerprint.device_type} - ${a.device_fingerprint.model}<br>
        <strong>OS:</strong> ${a.device_fingerprint.os_version}<br>
        <strong>ISP:</strong> ${a.network.isp}
      </div>
      
      <div class="bg-white/5 rounded-lg p-4">
        <strong>Outstanding Debt:</strong> $${a.tfd.outstanding_debt.toLocaleString()}<br>
        <strong>Total Loans:</strong> ${a.tfd.loan_history.length}
      </div>
    </div>
  `;
  document.getElementById('modal').classList.remove('hidden');
}

document.getElementById('testBtn').onclick = testAPI;
document.getElementById('searchBtn').onclick = searchEmail;
document.getElementById('closeModal').onclick = () => document.getElementById('modal').classList.add('hidden');

console.log("âœ… All event listeners attached");
console.log("ðŸ‘‰ Click TEST API button to load data");
</script>

</body>
</html>
